---
title: "Casal2 Test Case MPD comparisons for SCI"
output:
    html_document:
        toc: TRUE
        toc_depth: 2
        number_sections: TRUE

header-includes:
 - \usepackage{pdflscape}
 - \newcommand{\blandscape}{\begin{landscape}}
 - \newcommand{\elandscape}{\end{landscape}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# SCI comparison of CASAL and Casal2 model configurations

This document compares the results of at least 2 CASAL model configurations (base and at least one sensitivity) and up to 6 Casal2 model configurations (3 BetaDiff and 3 ADOL-C).

The CASAL model sensitivity 1 has a smaller minimisation tolerance value than the CASAL base model (1e-8 vs. 2e-6).

The Casal2 ADOL-C and BetaDiff low tolerance models have the same tolerance values than the CASAL base model (1e-8 vs. 2e-6).


## SCI model characteristics

The main characteristics of the Test Case SCI (Scampi) CASAL model are:

* length-based sex-specific model
* years 1986 - 2022, projection years 2023 - 2027
* three time steps, Oct - Jan, Feb - Apr, May - Sep
* estimate growth transition matrix
* dour tag releases
* Beverton-Holt stock-recruitment relationship, with steepness (h) 0.75 and $CV_R$ 0.7 (prior)
* length-weight relationship ($W = aL^b$)
* three fisheries

Observation data include:

* trawl fishery CPUE
* trawl survey abundance and proportions-at-length
* fishery proportions-at-length
* tag-recapture data for growth estimation
* maturity data

Parameters estimated include:

* B0
* sex-specific growth parameters
* maturity parameters
* YCS (recruitment deviations)
* sex-specific fishery and trawl selectivity parameters


## R environment

```{r C1_C2_setup, echo=FALSE, warning=FALSE, message=FALSE}
source('../../R-functions/report_set_up_R_env.R')
```


## CASAL and Casal2 model output

```{r CASAL, warning=FALSE}
source('../../R-functions/report_read_in_CASAL_MPD_files.R')
```


```{r Casal2}
source('../../R-functions/report_read_in_Casal2_MPD_files.R')
```



\newpage
\blandscape

## Tables

Tables of parameter estimates and objective function components for the CASAL and Casal2 model MPD results

```{r table_setup, echo=FALSE, warning=FALSE, message=FALSE}
source('../../R-functions/report_set_up_tables.R')

options(scipen=999)
```


```{r huxtables_parameters, echo=FALSE, warning=FALSE, message=FALSE}
source('../../R-functions/report_print_parameter_tables.R')

hux_C1_est_params
hux_C2_est_params
hux_C2_pd_est_params
```


```{r huxtables_obj_fun, echo=FALSE, warning=FALSE, message=FALSE}
source('../../R-functions/report_print_obj_fun_tables.R')

hux_C1_obj_fun
hux_C2_obj_fun
```


```{r convergence_info, echo=FALSE}
source('../../R-functions/report_print_convergence_info.R')
```


```{r warnings_and_bounds, echo=FALSE, warning=FALSE, message=FALSE}
source('../../R-functions/report_print_warnings.R')
```


```{r huxtables_close, echo=FALSE}
options(scipen=0)
```


\elandscape
\newpage



## Matching of outputs

Time series comparisons with CASAL base model results

```{r Time_Series_Match, echo=FALSE, warning=FALSE, message=FALSE}
source('../../R-functions/report_time_series_match_function.R')


c1_catch <- c1_quant$actual_catches$Trawl_1

for (c in 1:num_C2_models)
{
    print(paste('Catch time series base model comparison for run', C2_subdir[c]))

    print(paste('Actual catches for Trawl 1 match:', time_series_match(c1_catch, cas2_mpd[[c]]$Instantaneous_Mortality$`catch[Trawl_1]`)))

    print('')
}


c1_catch <- c1_quant$actual_catches$Trawl_2

for (c in 1:num_C2_models)
{
    print(paste('Catch time series base model comparison for run', C2_subdir[c]))

    print(paste('Actual catches for Trawl 2 match:', time_series_match(c1_catch, cas2_mpd[[c]]$Instantaneous_Mortality$`catch[Trawl_2]`)))

    print('')
}


c1_catch <- c1_quant$actual_catches$Trawl_3

for (c in 1:num_C2_models)
{
    print(paste('Catch time series base model comparison for run', C2_subdir[c]))

    print(paste('Actual catches for Trawl 3 match:', time_series_match(c1_catch, cas2_mpd[[c]]$Instantaneous_Mortality$`catch[Trawl_3]`)))

    print('')
}
```

Derived quantities

SB0, SBcurrent, MSY, F_MSY, others...



## Plots

Comparison plots

```{r plots_base, echo=FALSE}

# c(bottom, left, top, right)
par(mar=c(4,4,2,1) + 0.1)

par(mfrow=c(1,2))

bl_lwd <- 6
gr_lwd <- 3
```


```{r plots_correlation, echo=FALSE}
source('../../R-functions/report_plot_correlation_matrices.R')
```

