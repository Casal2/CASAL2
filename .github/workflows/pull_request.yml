name: Casal2 validate test suite
on:
  push:
    branches:
      - '*'  ## this will run actions on current branch, to change to main, needed for testing.
      ## taken from https://keithweaverca.medium.com/only-run-github-actions-on-specific-branches-694782fcc07
## for a release idea linux is fairly easy
## for windows look at this example https://github.com/freenet/wininstaller-innosetup/actions/runs/768471071/workflow
jobs:
  Compile-Casal2-linux:
  # should run on linux based operating system
  # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
    runs-on: ubuntu-18.04
    timeout-minutes: 60
    env:
      CC: gcc-10
      CXX: g++-10   
    steps:
      - uses: actions/checkout@v2
        with:
          # The branch, tag or SHA to checkout. When checking out the repository that
          # triggered a workflow, this defaults to the reference or SHA for that event.
          # Otherwise, uses the default branch.
          ref: age_length_redesign_202109

      - uses: actions/setup-python@v2    
        with:
          python-version: '3.8'
      - name: Install python dependencies
        run: pip install pytz python-dateutil --upgrade pip

      - name: Install gcc
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 10
          platform: x86

      - name: Build third-party library - adolc
        run: |
          cd BuildSystem
          ./doBuild.sh thirdparty adolc
      - name: Build third-party library - betadiff
        run: |
          cd BuildSystem
          ./doBuild.sh thirdparty betadiff

      - name: Build third-party libraries - boost
        run: |
          cd BuildSystem
          ./doBuild.sh thirdparty boost
      - name: Build third-party libraries - google test and mock
        run: |
          cd BuildSystem
          ./doBuild.sh thirdparty googletest_googlemock
      - name: Build third-party libraries - parser
        run: |
          cd BuildSystem
          ./doBuild.sh thirdparty parser
# remove documentation build, this is being removed from the build system.          
#      - name: Build documentation
#        run: |
#          sudo apt install texlive-latex-extra
#          cd BuildSystem
#          ./doBuild.sh documentation

      - name: Build "Betadiff" standalone binary
        run: |
          cd BuildSystem
          export CASAL2_BUILD_THREADS=16
          ./doBuild.sh release betadiff

      - name: Build "ADOL-C" standalone binary
        run: |
          cd BuildSystem
          export CASAL2_BUILD_THREADS=16
          ./doBuild.sh release adolc

      - name: Run model runner
        run: |
          cd BuildSystem
          ./doBuild.sh modelrunner

      - name: Build "Unit Test" standalone binary
        run: |
          cd BuildSystem
          ./doBuild.sh test
          
      - name: Run Unit Tests standalone binary
        run: |
          cd BuildSystem/bin/linux_gcc/test/
          ./casal2 test
  Compile-Casal2-Windows:
    # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
    runs-on: windows-2019 #windows-2016
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v2
        with:
          # The branch, tag or SHA to checkout. When checking out the repository that
          # triggered a workflow, this defaults to the reference or SHA for that event.
          # Otherwise, uses the default branch.
          ref: age_length_redesign_202109
      - uses: actions/setup-python@v2    
        with:
          python-version: '3.8'
      - name: Install python dependencies
        run: pip install pytz python-dateutil --upgrade pip

      - name: Install gcc
        uses: egor-tensin/setup-mingw@v2
        with:
          version: 10
          platform: x64

      - name: Build third-party library - adolc
        run: |
          cd BuildSystem
          ./doBuild.bat thirdparty adolc
      - name: Build third-party library - betadiff
        run: |
          cd BuildSystem
          ./doBuild.bat thirdparty betadiff          
      - name: Build third-party library - boost
        run: |
          cd BuildSystem
          ./doBuild.bat thirdparty boost

      - name: Build third-party libraries - google test and mock
        run: |
          cd BuildSystem
          ./doBuild.bat thirdparty googletest_googlemock

      - name: Build third-party libraries - parser
        run: |
          cd BuildSystem
          ./doBuild.bat thirdparty parser

      - name: Build "Betadiff" standalone binary
        run: |
          cd BuildSystem
          ./doBuild.bat release betadiff

      - name: Build "ADOL-C" standalone binary
        run: |
          cd BuildSystem
          ./doBuild.bat release adolc

      - name: Run model runner
        run: |
          cd BuildSystem
          ./doBuild.bat modelrunner          

      - name: Build "Unit Test" standalone binary
        run: |
          cd BuildSystem
          ./doBuild.bat test
          
      - name: Run Unit Tests standalone binary
        run: |
          cd BuildSystem/bin/windows_gcc/test/
          ./casal2 test
        
