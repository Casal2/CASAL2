\documentclass[a4paper,11pt,twoside,pdftex,draft]{article}

\usepackage[font=bf,format=hang,labelsep=colon,justification=justified,singlelinecheck=false,compatibility=false]{caption}

\usepackage{ifthen} % for conditional expressions
\usepackage{float} % for floating tables and graphics
\usepackage{setspace} % for defining spacing between lines
\usepackage{cmap} % allow searching in pdf documents
\usepackage{tabulary} % better tables
\usepackage{longtable}
\usepackage{comment} % block comments
\usepackage{multicol}
\usepackage[toc,page]{appendix}
\usepackage[usenames, dvipsnames]{color} % Highlighting text for editing
\usepackage[T1]{fontenc} % for searching for terms with underscores

\usepackage[bookmarks=true,bookmarksopen=true,bookmarksnumbered=true,
pdfpagelayout=TwoPageRight,pdftex]{hyperref}
\hypersetup{
breaklinks=true,    % allow line breaks in URLs
colorlinks=true,    % use colour to define links
linkcolor=cyan,     % colour of internal links
citecolor=black,    % colour of links to bibliography
filecolor=red,      % colour of file links
urlcolor=blue,      % colour of external links
anchorcolor=black,
final=true
}

% Use AMS Maths
\usepackage[fleqn]{amsmath}
\newcommand\AddVspace{\\[0 pt]} % artificial method of adding vertical space within equations

% Package for including and pretty printing of external config files and program code
%\usepackage{listings}
%\lstset{ %
%	basicstyle=\ttfamily\footnotesize,
%	breaklines=true,
%	columns=fullflexible,
%	showspaces=false,               % show spaces adding particular underscores
%	showstringspaces=false,         % underline spaces within strings
%	showtabs=false,                 % show tabs within strings adding particular underscores
%	tabsize=2,                      % sets default tabsize to 2 spaces
%	breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
%	escapeinside={\%*}{*)}          % if you want to add a comment within your code
%}

% text blocks without syntax highlighting
\usepackage{alltt}

% Allow colour for HTML links
\usepackage{color,soul}
\definecolor{darkgray}{gray}{0.20}
\definecolor{lightgray}{gray}{0.95}

% Geometry for A4 layout like MS-Word defaults
\usepackage[left=2.54cm,top=2.54cm,bottom=2.54cm,right=2.54cm]{geometry}

% Natlib to better cite references (round brackets, commas between refs, and sorted)
\usepackage[round,comma,sort]{natbib}

% watermark
\usepackage{draftwatermark}

% Making the index
\usepackage{makeidx}
\makeindex

% Graphics (no postscript files.. just use jpeg, png, etc)
%\usepackage[dvips]{graphicx}

% Changes fonts to Times, Helvetica, Courier
\usepackage{pslatex}

\usepackage[normalem]{ulem}

% Section header fonts
\usepackage{sectsty}
\allsectionsfont{\sffamily\large} % Normal sized arial style section headings
% Add a dot after section headings
\makeatletter
\def\@seccntformat#1{\csname the#1\endcsname.\quad}
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
{-2.5ex\@plus -1ex \@minus -.25ex}%
{1.25ex \@plus .25ex}%
{\normalfont\normalsize\bfseries}}
\makeatother

\setcounter{secnumdepth}{4} % how many sectioning levels to assign numbers to
\setcounter{tocdepth}{4}    % how many sectioning levels to show in ToC

% Page style
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead{}
\fancyfoot{}
\headheight 15pt
\renewcommand{\headrulewidth}{0pt} % rule line under header
\renewcommand{\footrulewidth}{0pt}
\setlength{\parindent}{0pt} % No indentation at start of paragraph
\setlength{\baselineskip}{1ex plus 0.2ex minus 0.1ex}
\setlength{\parskip}{1.1ex} % Gap between paragraphs
\raggedbottom % prefer space at the bottom of page

% Make equation numbers be section number then equation number
\makeatletter
\@addtoreset{equation}{section}
\@addtoreset{figure}{section}
\@addtoreset{table}{section}
\def\thefigure{\thesection.\@arabic\c@figure}
\def\thetable{\thesection.\@arabic\c@table}
\def\theequation{\thesection.\@arabic\c@equation}
\makeatother

%% stop figures from going onto a page by themselves
\renewcommand{\topfraction}{0.85}
\renewcommand{\textfraction}{0.1}
\renewcommand{\floatpagefraction}{0.75}

% Minimise hyphen use
\hyphenpenalty=5000
\tolerance=1000

\newcommand{\CNAME}{\textsc{Casal2}}


% Title Page
\title{Proportions-at-weight, a new Observation type}
\author{Matt Dunn, Ian Doonan, Teresa A'mar}
\date{February 2021}


\begin{document}
\maketitle

\pagestyle{plain}
\setcounter{page}{1}


\newpage

\section{Overview}

Overview

\section{Conceptual Description}

The observation process\_removals\_by\_weight was added to allow the use of fish market data, where fish weights have been measured instead of fish lengths or ages, which are collated into proportions-at-weight. The observation is strictly from retained catch and is therefore associated with mortality from a defined fishery. When discarding is included in the model, the retained selectivity should be used for these data. If there are no discarding, then the total catch selectivity is used. However, for current coding purposes, this observation must be linked to a fishery as defined in a mortality\_Instantaneous block, which ignores discards and so the selectivity is that defined in the mortality\_Instantaneous block.

The expected proportions-at-weight are derived from normalizing the expected numbers-at-weight. There are two stages in calculating the expected numbers-at-weight. Firstly, \CNAME~ calculates the expected numbers-at-length from the numbers-at-age using the age-length and distribution in the \texttt{@age\_length} block. Secondly, the numbers-at-length are converted into numbers-at-weight using the length-weight relationship in the \texttt{@length\_weight} block and its distribution of weight about the mean weight-at-length. The length-weight distribution is currently only applied in \CNAME~ in the \texttt{@observation} block for weight composition data and is therefore specified here, as the CV of either a normal or lognormal distribution.

The user must specify the units of weight for the proportions-at-weight observations (which may be g or kg), a vector containing the lower edge of each weight bin, and a vector containing the proportions in each weight bin. Note that units for weight in the proportions-at-weight do not have to be the same as specified in \texttt{@length-weight}. Observation-specific weight bins must be a sequential subset of the model weight bins, with no missing or added values. Observations may be specified for any category used in the partition, or for some combinations of them [LINK TO CATEGORY SECTION?], e.g., for both males and females separately, or alternately, one set for combined sex. The weight bins must be the same for each year; if this is not the case, then years for which they are different need to be entered as different process\_removals\_by\_weight blocks.

If there is no plus group, i.e., weight\_plus=false, then \CNAME~ requires a vector of proportions-at-weight of length n+1, where n is the number of lower edges of each weight bin supplied (the final value provides the upper limit to the final bin). If weight\_plus=true then \CNAME~ expects a vector of proportions-at-weight of length n. The last proportion represents the numbers from the last length bin to the maximum weight the age-weight relationship allows [not sure how we should specify this?].

\CNAME~ generates a warning if the mean weight estimated for the youngest age in the partition is greater than the lower size of the first weight bin. This is to guard against including weight observations that may have a substantial contribution from fish younger than the youngest age in the partition.

The only likelihood currently available in \CNAME~ for proportions\_at\_weight observations is the multinomial, with effective sample sizes for each year provided as error\_values. Note that in the implementation of the multinomial likelihood in \CNAME, the weight bins having a value of zero will have no contribution to the likelihood.

No specification is made for the specific time within the timestep that the same was taken. This is because the sample is linked to a fishery, where removed are defined to be at the mid-point.

Proportions-at-weight processes:

\begin{itemize}
	\item process\_removals\_by\_weightfishery using Instantaneous\_Mortality;
	\item process\_removals\_by\_weight\_retainedfishery using Instantaneous\_Mortality\_Retained; LEAVE OUT FOR NOW IJD?
	\item process\_removals\_by\_weight\_retained\_totalfishery using Instantaneous\_Mortality\_Retained LEAVE OUT FOR NOW IJD?
\end{itemize}

documented in Section 7.1.3 (of the User Manual?). Specific process observations (i.e., fishery tied observations; obs fitted to the middle of the fishery since it represents it)

We have ``general'' obs like process\_proportions\_at\_length, which are used for surveys, but also for fisheries; they can be fitted into any place throughout the time-step. Weight frequencies are not collected on surveys, so we do not need this observation yet.

Length composition observation types for fisheries.


Linked to mortality\_instantaneous, \CNAME~ has these fishery length composition data observations:

\begin{itemize}
	\item process\_removals\_by\_length: works with process of type mortality\_instantaneous;
	\item process\_removals\_by\_length\_retained: works with process of type mortality\_instantaneous \_retained; and
	\item process\_removals\_by\_length\_retained\_total: works with process of type mortality\_instantaneous \_retained
\end{itemize}

Fisheries process: mortality\_instantaneous

Supply time step.

Specific fishery is a method in the table method in the  mortality\_instantaneous block. For one stock, it only makes sense to have one mortality\_instantaneous block that covers all fisheries on the stock (whatever time-step they occur in) and specifies the proportions of M that occurs in each time-step. Rather than covering one process in a specific time-step, mortality\_instantaneous blocks cover the full year which makes it different from other processes. mortality\_instantaneous blocks need to be like this so that M and F can occur simultaneously and to also make sure the various U\_max parameters are evaluated at the same time if fisheries co-occur.

Alt fisheries process mortality\_instantaneous \_retained:  same as above, but with discards and retained catch

Copied from the manual, but changed into proportions-at-weight.

Proportions-at-weight observations can be supplied as

\begin{itemize}
	\item a set of proportions for a single category (see example);
	\item a set of proportions for multiple categories; or
	\item a set of proportions across aggregated categories.
\end{itemize}

The method of evaluating expectations are the same for all three types of proportions.


Defining an observation for multiple categories extends the single category observation definition. It is used to model a set of proportions over several categories by weight bin. For example, to specify that the observations are of the proportions of male or females within each weight bin, then the subcommand categories is

\texttt{categories male female}

The vector of proportions will have the proportion for males over the specified weight bins, followed by the proportions for females. The sum over male and female proportions should be 1 (i.e., it implicitly has a sex ratio).

Defining an observation across aggregated categories allows categories to be aggregated before the proportions are calculated.  To indicate that two (or more) categories are to be aggregated, separate them with a "+" symbol. For example, to specify that the observations are of the proportions of male and females combined within each weight bin, then the subcommand categories is

\texttt{categories male + female}

\CNAME~ then requires that there will be a single vector of proportions supplied, with one proportion for each weight bin, and that these proportions sum to one.

The latter form can then be extended to include multiple categories, or multiple aggregated categories, e.g., for an east and west combined sex proportions that incorporates an area ratio we could use

\texttt{categories male.east + female.east   male.west + female.west}

\CNAME~ then requires that there will be a vector made up by a concatenated of proportions for east and another for west, and that these proportions sum to one.

\section{Technical Description}


The observation is supplied for a given year and time-step, for some selected age classes of the population (i.e., for a range of ages multiplied by a selectivity that is associated with the process).
For length selectivities in an age-based model, we must apply the selectivity onto the age-length matrix, so do we generate the length-age matrix first, then apply whatever selectivity is needed?

The expectations from this observation are generated whilst the process is being executed. There is a chain of expectations starting with that for ages, then converting this into an expectation for lengths, and lastly, converting lengths into expectations over weight bins.

The expectation of numbers at age $a$ for category $c$ from exploitation method $m$ ($E[N_{a,c,m}]$) are

\begin{equation}
E[N_{a,c,m}] = N_{a,c} U_{a,m} S_{a,c,m} 0.5 M_{a,c}
\end{equation}

where $N_{a,c}$ are the numbers at age in category $c$ before the process is executed, $U_{a,m}$ is the exploitation rate for age $a$ from method $m$, $S_{a,c,m}$ is the selectivity, and $M$ is the natural mortality. This is OK for age-based selectivities, but for length based selectivity (in an age-based model), a form of age to length transition is done, but the probabilities use numerical integration within an age bin, so there may be speed advantages to incorporating this into the age-to-length transition matrix calculations below. Given $U_{a,m}$ needs $S_{a,c,m} $, it is cleaner to keep length-based selectivity calculations separate for now.


\subsection{Part 1: age to length transition}
We now use the specified length bins in the \texttt{@model} command block to generate expectations. This is a transition matrix,\boldmath$Tal$,that converts proportions of an age into the vector of  lengths bins; columns are ages, rows are length bin index so $Nl_{c,m} = \mathbf{Tal} N_{c,m}$, where $Nl$ and $N$ are (column) vectors.

We drop then $m$ subscribe (method) for here on.

For the normal distribution of length about an age, 
elements of $\mathbf{Tal}$ for length bin $l$ and age $a$ in category $c$ are given by $\zeta_{l,a,c} = \Phi\left( \frac{L_{l+1} - \bar L_{c,a}   }{\sigma_{c,a}} \right)   - \Phi\left( \frac{L_{l} - \bar L_{c,a}   }{\sigma_{c,a}} \right)  $,
where $\Phi$ is the standard normal cumulative function with mean length $\bar L_{c,a}$ and standard deviation $\sigma_{c,a}$. For a log-normal distribution, the $L_{l}, \bar L_{c,a}$ and $\sigma_{c,a}$ must be on the log scale.

Notice that when the length distribution has a probability of lengths below $L_{1}$ these fish are ``lost''
which is different to SS3 manual equation A.1.14 where fish in bin $1$ are for fish below $L_{1}$.

The calculation for last length bin, $l_{max}$, depends on whether a length plus-group is defined in \texttt{@model} length bins. For no plus-group, $l_{max}$ is one less than the number of lengths specified since the last length caps the interval for bin $l_{max}$. If we index the last length as $l_{cap}$
then 

$\zeta_{l_{max},a,c} = \Phi\left( \frac{L_{l_{cap}} - \bar L_{c,a}   }{\sigma_{c,a}} \right)   - \Phi\left( \frac{L_{l_{max}} - \bar L_{c,a}   }{\sigma_{c,a}} \right)  $. 

For a plus-group in \texttt{@model} length bins, $l_{max}$ indexes the bin that starts at  the last specified length, but includes all length larger than it. $\zeta_{l_{max},a,c}$ is now  $ 1 - \Phi\left( \frac{L_{l_{max}} - \bar L_{c,a}   }{\sigma_{c,a}} \right)$.

If growth is not time varying, then $\mathbf{Tal}$ should be calculated once. If length-weight relationships are time-varying, then $\mathbf{Tal}$ should be saved and re-used.

\bigskip
\underline{Warnings}

The age ranges specified in \texttt{@model} can exclude the youngest ages, but invariably it has a maximum age, usually with a plus-group. Both situations can create bias in predicting length distributions in certain circumstances.  If the age plus-group is not located where the mean length is at $L_{\infty}$, some parts of the length distribution within the age plus-group are not represented and this will result in a bias for length composition data where a length plus-group is specified. This is only an issue in the early part of the model run when the fishdown is occurring, after which it will disappear as the age plus-group is emptied.  A bias may also occur when the youngest ages are excluded if their length distribution(s) overlaps with the smaller length bins in the model. We should detect this, if possible, and issue a warning to alert the practitioner. 
Can we make growth functions take ages outside the age range to predict mean length (it may do this already - TA)? If so, \CNAME\  can calculate how much the age class below the minimum age (if this is greater than one) contributes to the \texttt{@observation} length composition. 

For age plus-groups, \CNAME\  should be able to generate the cumulative distribution for the terminal length distribution and for years \begin{verbatim} 
max_age plus c(5, 10, ...)
\end{verbatim}
 which can be inspected by the user to check the likely consequences of their proposed configuration. For age plus-groups, what age to use for the terminal length distribution is unclear, maybe just \texttt{age.max}. 
In CASAL, age plus-groups have a parameter to specify the length to used for the weight calculations, which implies an age. In \CNAME, I am unsure what happens given the manual entries:

\begin{verbatim}
@model
length_plus_group The mean length of length plus group #can this be specified statically (IJD)?
default 0  #??

age_plus The oldest age or extra length midpoint ,plus group size, as a plus group??
Type: boolean
Default: true
Value: true, false
\end{verbatim}

I am unsure what has been done here and what would be better (IJD).
For age plus-groups, should we have \texttt{@model/age\_plus\_age/default age\_max} to define the terminal length distribution and mean length for weight calculations?
Similarly for length plus-groups, should we have \texttt{@model/length\_plus\_length/default length\_max} to define the terminal weight distribution and mean weight for weight calculations? Maybe the \texttt{@model/length\_plus\_group} above does this already?

\subsection{Part 2: age to weight transition}
Here, $\mathbf{Tal}$ is converted into $\mathbf{Taw}$, the age to weight transition matrix. First, a version is calculated using the weight bins specified in \texttt{@model}, $\mathbf{TawM}$. Second, this is transformed into the specific weight bins specified in the \texttt{@observation} section, $\mathbf{TawO}$. 

The   \texttt{@observation}  weight bins must be consistent with the  \texttt{@model} bin boundaries, i.e.,  \texttt{@observation} bins cannot cut a 
\texttt{@model} bin into two or extend outside its range. It can concatenate \texttt{@model} bins and it does not have to cover the full range. \texttt{@observation} bins cannot have ``holes'' in it. 
Holes and bin consecutive order in the specifications should be checked for in both the \texttt{@observation} and \texttt{@model} versions (this has caused problems for length bins).


An intermediate matrix is needed that converts length into a weight distribution, $\mathbf{Tlw}$. This uses the \texttt{@model} length bins so it fits to the $\mathbf{Tal}$, i.e. $\mathbf{TawM} =mathbf{Tal} mathbf{Tlw} $.

For the normal distribution of weight about length, 
elements of $\mathbf{Tlw}$ for weight bin $w$ and length $l$ in category $c$ are given by $\zeta_{w,l,c} = \Phi\left( \frac{W_{w+1} - \bar w_{c,l}   }{\sigma_{c,l}} \right)   - \Phi\left( \frac{W_{w} - \bar W_{c,l}   }{\sigma_{c,l}} \right)  $,
where $\Phi$ is the standard normal cumulative function with mean weight $\bar W_{c,l}$ and standard deviation $\sigma_{c,l}$. Is there going to be a log-normal version (MD)? 

We are not allowing a weight plus-group (?) so the above defines calculations needed. A  plus-group can be made by increasing the $W_{w_{max}}$ to a unlikely value.

Now  $\mathbf{TawM} =\mathbf{Tal} \ \%*\%\ \mathbf{Tlw} $.

Do we need the \texttt{@model} weight bin? If there are more than one series of weight composition data then \texttt{@model} weight bins will save some time. Is this the case (MD)? The $\Phi$ calculations are expensive since they use exp() and raising to powers up to 5 (or is it 7?) so calculating them once could be advantageous. 


To get the finial transition matrix, $\mathbf{TawO}$ we may need to delete \texttt{@model} bins (columns) from both ends and potentially add over internal bins. If $wm_{i}$ are the lower weight bin boundaries (\texttt{model}) for $i=1 ... m-1$ bins ($m^{th}$ value defines the cap for the last bin), and $wo_{j}$ are the lower boundary values  (\texttt{observation}) for  $j=1 ... n-1$ bins, then an $j$ index can be assigned to each \texttt{model} bin based on $wo_{j} <= wm_{i} <wo_{j+1}$; for no fits than 0 is assigned (i.e., deletion). R code is
\begin{verbatim}
    j.wm	#j index for model bin into observation bin
    TawO <- matrix(rep(0,(n-1)*(max.age - min.age +1)),ncol=m-1)
	
    for(i in c(1,m-1)){
    	    TawO[,j.wn[i]] <- TawO[,j.wn[i]] + TawM[,i]
        	}
		
\end{verbatim}

If growth and length-weight relationships are both not time-varying, then $\mathbf{TawO}$ should be saved and re-used for the other years. If both growth and length-weight parameters are not being estimated, and both are not time-varying, $\mathbf{TawO}$ only needs to be calculated once.

\subsection{Predicted weight composition}



$\overrightarrow N_{c,m}$ is the $n_{age}\ x\ 1$\ column vector of expected numbers-at-age based on $E[N_{a,c,m}]$ from above. Doing this isolates the transition matrix from selectivity in case it is time-varying.

First we calculated the predicted weight composition for single fish measurements (i.e., the above derivation) by $\overrightarrow W_{c,m}\ =\ \mathbf{TawO_{c,m}^T}\ \overrightarrow N_{c,m}$.
[$nx1$ vector\ \ \ $n\ x\ n_{age}$\ matrix times $n_{age}\ x\ 1$\ vector]. Then normalize $\overrightarrow W_{c,m}$.

\subsection{Accounting for data being mean weight composition}
$\overrightarrow W_{c,m}$\ is put into the multinomial log-likelihood.

Do we adjust sample size by the mean number of fish in a box? Or, do we allow reweighting to do the adjusting?

DOES NOT ACCOUNT FOR DATA BEING MEANS OVER $n_i$ FISH IN EACH BOX.

The data are for mean weights for individuals about the same size (=length?) (yes?).
So we can use the length-weight relationship to predict its mean weight.
The length-weight has a cv (say 10\%) which reflects the variation of weight for a length, but this is for one fish, not the 4 that are in the box. If all boxes have 4 fish the we just use 10/2 = 5\% for the cv = easy fix.

But, does the mean number of fish vary significantly across the boxes?
Numbers from 3 to 5 could be approx. by 4.
With the switch to juveniles, does the number/box go to 10? 20?

The later might need variable adjustments to the cv across the weight bins, i.e., large numbers decreasing down to 4.
In that case, we will need a mean number/box for each bin and do the adjustments when calculating transition matrix, i.e., cv\_bin = cv/sqrt(n\_bin).

For the time being, we can leave it as is, i.e., adjust weight distribution cv to be cv/2.

\bigskip
\underline{Warnings}

There might be the same issues as for lengths, except that we will not allow a weight plus-group


\section{Proposed Input Format}

Example input block

\begin{alltt}
\texttt{@observation Observed\_weight\_frequency\_east}
type process\_removals\_by\_weight
method\_of\_removal EastChathamRise  # fishery
time\_step Summer # Not truly needed, but length code needs it currently
mortality\_instantaneous\_process instant\_mort
length\_weight\_cv 0.1
length\_weight\_dist lognormal
years 1991 1992
categories male
weight\_unit kg
delta 1e-5  # robustification value for the likelihood; default 1e-11
likelihood multinomial
weight\_plus false        #not allowed?
weight\_bins 1.8 1.9 2.0 2.1 2.2 2.3 2.4 2.5 2.6 2.7 2.8 2.9 3.0 3.1 3.2 3.3 3.4 3.5 3.6 3.7 % 3.8 3.9 4.0 4.1 4.2 4.3 4.4 4.5 4.6 4.7 4.8 4.9 5.0 5.1 5.2 5.3 5.4 5.5 5.6 5.7 5.8 5.9 6.0 6.1 6.2 6.3 6.4 6.5 6.6 6.7 6.8 6.9 7.0 7.1 7.2 7.3 7.4 7.5 7.6 7.7 7.8 7.9 8.0 8.1 8.2 8.3 8.4 8.5 8.6 8.7 8.8 8.9 9.0 9.1 9.2 9.3 9.4 9.5 9.6 9.7 9.8 9.9 10.0 10.1 10.2 10.3 10.4 10.5 10.6 10.7 10.8 10.9 11.0 11.1 11.2 11.3 11.4 11.5 11.6 11.7 11.8

table obs
1991 0.002 0.010 0.041 0.094 0.126 0.086 0.073 0.051 0.045 0.050 0.037 0.025 0.016 0.017 0.011 0.008 0.011 0.011 0.009 0.012 0.013 0.009 0.010 0.009 % 0.0100.0070.0080.0060.0050.0100.0080.0140.0080.0120.0060.0070.0090.0050.0070.0060.0040.0060.0040.0040.0070.0050.0020.0060.0040.0030.0040.0020.0040.0030.0020.0020.0020.0010.0020.0030.0010.0020.0010.0010.0010.0010.0010.0010.0010.0000.0010.0010.0000.0010.0010.0010.0010.0000.0010.0010.0010.0010.0010.0010.0000.0010.0000.0010.0000.0000.0010.0000.0000.0000.0000.0000.0000.0000.0000.001
1992 0.002 0.006 0.016 0.018 0.027 0.038 0.058 0.069 0.051 0.061 0.063 0.052 0.032 0.028 0.021 0.018 0.013 0.012 0.008 0.011 0.012 0.007 0.012 0.012 % 0.0150.0070.0090.0110.0090.0100.0140.0130.0120.0190.0110.0130.0130.0090.0100.0140.0080.0090.0060.0060.0080.0080.0050.0080.0070.0060.0030.0060.0060.0040.0020.0040.0070.0030.0040.0030.0020.0030.0020.0020.0020.0020.0020.0020.0020.0020.0020.0010.0010.0010.0020.0020.0010.0020.0020.0020.0010.0010.0010.0020.0010.0010.0010.0010.0010.0000.0010.0010.0000.0010.0010.0000.0000.0010.0000.001
end\_table

table error\_values
1991 25
1992 25
end\_table
\end{alltt}

\section{Test Plan}

Simulate some test data in R which can become a unit test.

\section{Text to be added to the User Manual}

observations 7.7x

\paragraph*{Process removals by weight}

Removals by weight observations are observations of the relative number of individuals at weight, part way through a process of type \texttt{mortality\_instantaneous}. This observation is exclusively associated with the process of type \texttt{mortality\_instantaneous}, and will produce an error if associated with any other process type.

The observation is supplied for a given year and time-step, for some selected age classes of the population (i.e., for a range of ages multiplied by a selectivity that is associated with the process).

The expectations from this observation are generated whilst the process is being executed. The expectation of numbers at age $a$ for category $c$ from exploitation method $m$ ($E[N_{a,c,m}]$) are

\begin{equation}
E[N_{a,c,m}] = N_{a,c} U_{a,m} S_{a,c,m} 0.5 M_{a,c}
\end{equation}

where $N_{a,c}$ are the numbers at age in category $c$ before the process is executed, $U_{a,m}$ is the exploitation rate for age $a$ from method $m$, $S_{a,c,m}$ is the selectivity, and $M$ is the natural mortality.

The observation class accesses the variable $E[N_{a,c,m}]$ from the process and applies the age-length relationship specified in the model. This converts numbers-at-age to numbers-at-age and -length. In turn, numbers-at-length and -age are converted into numbers at -age and -weight using the length weight relationship and the spread of weights about a length, which are then converted to numbers-at-weight.  The observations are aggregated by method and category depending on how the user specifies the observation, before converting numbers-at-weight to proportions and calculating the likelihood.

Similar to the proportions-at-length and removels-by-weight observation types, the user must supply a vector of weight bins. The observation-specific weight bins must be a sequential subset of the model weight bins, with no missing or added values. For example, if the model weight bins are \texttt{0 5 10 15 20 25 ... 100}, then the observation-specific weight bins can be \texttt{20 25 30 35 40 45 50} but not \texttt{20 30 40 50}. The length bins used int eh intermediate step to get the numbers-at-age and -length uses the model length bins. For time invarient growth and length weight relationships, the transition matrix from numbers-at-age to numbers at weight is calulated once at the start of a run and stored to be reused in other years to speed up htis observation class.

Currently, \CNAME~ does not allow a weight plus group. WARNING: The user should check that the weight range for fish in the age plus-group is consistent with the specified weight bins for the years with weight compositional data (e.g., weight compositional data collected when the stock has been fished down and so the age plus-group has insignificant fish in it meets this criteria). SImarly for model length bins.

{\small{\begin{verbatim}
@observation observation_fishery_WF
type process_removals_by_weight
...
years  1993 1994 1995
method_of_removal FishingEast
mortality_instantaneous_process instant_mort
weight_bins 0 20 40 60 80 110
delta 1e-5
table obs
1993    0.0   0.05    0.05    0.10    0.80
1994    0.05  0.1     0.05    0.05    0.75
1995    0.3   0.4     0.2     0.05    0.05
end_table

table error_values
1993 31
1994 34
1995 22
end_table
\end{verbatim}}}

Likelihoods that are available for this observation are the mulitnomial and the lognormal. See Section~\ref{sec:likelihood-observations} for information on the  likelihoods.

\section{References}

X

\end{document}
